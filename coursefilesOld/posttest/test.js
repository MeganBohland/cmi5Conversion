var pools = [

    // Q1
    [
        {
            stimulus: "1. Trafficking in persons is a problem in DoD in what following ways?  Select all that apply:",
            qType: "mr",
            choices: [
                "DoD members were prosecuted as traffickers",
                "DoD members were penalized for being buyers",
                "DoD members have been identified as victims of human trafficking",
                "DoD contractors have been investigated for sex and labor trafficking"

            ],
            answers: [1,1,1,1],
            lessonIndex: 0
        },
        {
            stimulus: "1. Trafficking in persons is not a problem in DoD.",
            qType: "mc",
            choices: [
                "True",
                "False"

            ],
            answers: [0,1],
            lessonIndex: 0
        }
    ],
    // Q2
    [
        {
            stimulus: "2. Trafficking in persons consists of which of the following? Select all that apply.",
            qType: "mr",
            choices: [
				"Child soldiering",
				"Drug trafficking",
				"Labor trafficking",
				"Sex trafficking"
			],
            answers: [1,0,1,1],
            lessonIndex: 0
        },
        {
            stimulus: "2. Sex trafficking consists of which of the following? Select all that apply.",
            qType: "mr",
            choices: [
				"The recruitment, harboring, transportation, provision, obtaining, patronizing, or soliciting of a person for the purpose of a commercial sex act.",
				"The forcing of a person to drink excessively",
				"Drug trafficking",
				"Weapon trafficking"
			],
            answers: [1,0,0,0],
            lessonIndex: 0
        },
        {
            stimulus: "2. Involuntary servitude and Debt bondage are forms of forced labor.",
            qType: "mc",
            choices: [
                "True",
                "False"
			],
            answers: [1,0],
            lessonIndex: 0
        }
    ],
    // Q3
    [
        {
            stimulus: "3. Traffickers use which of the following tactics to compel a person into commercial sex or forced labor?",
            qType: "mc",
            choices: [
                "Force",
                "Fraud",
                "Coercion",
                "All of the above"
            ],
            answers: [0,0,0,1],
            lessonIndex: 0
        },
        {
            stimulus: "3. Suspect actions of traffickers include recruitment, harboring, transporting, providing, obtaining (and for sex trafficking patronizing or soliciting prostitution).",
            qType: "mc",
            choices: [
                "True",
                "False"
            ],
            answers: [1,0],
            lessonIndex: 0
        }
    ],
    // Q4
    [
        {
            stimulus: "4. Trafficking in persons occurs for many reasons including:",
            qType: "mc",
            choices: [
                "The worldwide demand for commercial sex or cheap labor",
                "Economic or political instability, war, civil unrest, and natural disasters ",
                "Criminal enterprises that use human trafficking to fund their operations",
                "All of the above"
            ],
            answers: [0,0,0,1],
            lessonIndex: 0
        },
        {
            stimulus: "4. Large scale migration is a factor in the occurrence of trafficking in persons.",
            qType: "mc",
            choices: [
                "True",
                "False"
            ],
            answers: [1,0],
            lessonIndex: 0
        }
    ],
    // Q5
    [
        {
            stimulus: "5. Victims of trafficking can be (Select all that apply):",
            qType: "mr",
            choices: [
				"Female or male",
				"Adult or child",
				"Foreign national or U.S. citizen",
				"Service members, DoD civilians, and DoD contractor employees, DoD family members"
			],
            answers: [1,1,1,1],
            lessonIndex: 0
        },
        {
            stimulus: "5. In actual cases in the U.S. traffickers were (Select all that apply):",
            qType: "mr",
            choices: [
				"Members of organized crime or terrorist groups",
				"Business owners",
				"Family members ",
				"Service members, DoD civilians, and DoD contractors, DoD family members"
			],
            answers: [1,1,1,1],
            lessonIndex: 0
        }
    ],
    // Q6
    [
        {
            stimulus: "6. Which of these impact the U.S. Military's mission and readiness? Select all that apply.",
            qType: "mr",
            choices: [
                "Sex traffickers operate near U.S. military installations to target Service members",
                "Subcontractor employees working on U.S. government contracts on military installations have been subjected to steep recruitment fees, unsafe working and living conditions, or violence and abuse ",
                "Children are used in rogue or extremist militias as soldiers, spies, messengers, guards, and sex slaves",
                "Terrorist, organized crime, and extremist groups use trafficking in persons to fund their operations"
            ],
            answers: [1,1,1,1],
            lessonIndex: 0
        },
        {
            stimulus: "6. Trafficking in Persons only occurs in poor regions of the world.",
            qType: "mc",
            choices: [
                "True",
                "False"
            ],
            answers: [0,1],
            lessonIndex: 0
        }
    ],
    // Q7
    [
        {
            stimulus: "7. Trafficking in persons could take place in which of the following locations?",
            qType: "mc",
            choices: [
                "In the United States",
                "In a war zone",
                "In a politically unstable country",
                "All of the Above"
            ],
            answers: [0,0,0,1],
            lessonIndex: 0
        },
        {
            stimulus: "7. Children, including the children of military members, may be targets for traffickers online, at schools, or in neighborhoods.",
            qType: "mc",
            choices: [
                "True",
                "False"
            ],
            answers: [1,0],
            lessonIndex: 0
        },
        {
            stimulus: "7. Traffickers have sophisticated business models involving new technologies including smartphones, social media, and specialized apps.",
            qType: "mc",
            choices: [
                "True",
                "False"
            ],
            answers: [1,0],
            lessonIndex: 0
        }
    ],
	// Q8
    [
        {
            stimulus: "8. Which of the following signs most likely indicates a trafficking in persons situation?",
            qType: "mc",
            choices: [
				"A person doesn't have control of their identification documents",
				"A person is seen in a run-down restaurant",
				"A person has a locked security safe",
				"There is alcohol on the premises"
			],
            answers: [1,0,0,0],
            lessonIndex: 0
        },
        {
            stimulus: "8. Any person under the age of 18 found in commercial sex is a per se victim and no proof of force, fraud, or coercion is needed.",
            qType: "mc",
            choices: [
                "True",
                "False"
            ],
            answers: [1,0],
            lessonIndex: 0
        }
    ],
    // Q9
    [
        {
            stimulus: "9. The Trafficking Victims Protection Act of 2000 does which of the following?",
            qType: "mc",
            choices: [
				"Provides a 3 P Framework (Prevention, Prosecution, Protection) for addressing human trafficking",
				"Provides resources for survivors",
				"Prohibits by law sex trafficking and labor trafficking",
				"All of the Above"
			],
            answers: [0,0,0,1],
            lessonIndex: 0
        },
        {
            stimulus: "9. Prosecutable offenses under Article 134 of the UCMJ related to sex trafficking include prostitution, patronizing a prostitute, and pandering by compelling, inducing, enticing, or procuring an act of prostitution.",
            qType: "mc",
            choices: [
                "True",
                "False"
            ],
            answers: [1,0],
            lessonIndex: 0
        }
    ],
    // Q10
    [
        {
            stimulus: "10. One method for combating trafficking in persons is to be informed and learn the signs and indicators of trafficking in persons.",
            qType: "mc",
            choices: [
                "True",
                "False"
            ],
            answers: [1,0],
            lessonIndex: 0
        },
        {
            stimulus: "10. Check all the following methods to combat TIP that are true:",
            qType: "mr",
            choices: [
                "Only purchase sex in a country where prostitution is legal",
                "Avoid establishments that have signs or indicators of TIP",
                "Ignore a person who is being forced to sell sex or perform labor",
                "Report all suspected TIP incidents through your chain of command"
            ],
            answers: [0,1,0,1],
            lessonIndex: 0
        }
    ],
    // Q11
    [
        {
            stimulus: "11. You have a responsibility to report any trafficking in persons incidents you may witness, avoid establishments that show indicators of trafficking in persons, and report these establishments to your chain of command.",
            qType: "mc",
            choices: [
                "True",
                "False"
            ],
            answers: [1,0],
            lessonIndex: 0
        },
        {
            stimulus: "11. Which of the following is an appropriate action if you suspect a trafficking in persons violation? Select all that apply.",
            qType: "mr",
            choices: [
                "Contact your chain of command",
                "Ignore the situation",
                "Contact the Department of Defense Inspector General (IG)",
                "Discuss the situation with your colleagues using social media"
            ],
            answers: [1,0,1,0],
            lessonIndex: 0
        }
    ],
    // Q12
    [
        {
            stimulus: "12. At which point should you report a trafficking in persons situation?",
            qType: "mc",
            choices: [
                "After you discuss it with your colleagues",
                "After you have substantial proof",
                "Do not report it unless the situation is affecting your job",
                "Immediately upon suspecting a violation"
            ],
            answers: [0,0,0,1],
            lessonIndex: 0
        },
        {
            stimulus: "12. Which of the following is an appropriate action if you come across a trafficking in persons violation?",
            qType: "mc",
            choices: [
                "Report the situation only if you are outside the United States",
                "Contact the Department of Defense Inspector General (IG)",
                "Ignore it",
                "Involve yourself in the situation"
            ],
            answers: [0,1,0,0],
            lessonIndex: 0
        }
    ]
];

var formQuizData = {
    forms: [
        {
            questions: [],
            buttonText: 'Submit',
            fbType: "none",
            feedback: {
                positive: ["Congratulations! You have answered all questions correctly. Select the Next Lesson tab at the top of the page to continue."],
                negative: ["Incorrect. You have incorrectly answered one or more questions."]
            }
        }
    ],
    maxAttempts: 99
};

// for every pool add one random question from that pool.


addEvent(window, 'load', initFormQuiz);

var firstAttempt = true,
    myFormQuiz, 
    listId,
    numCorrect = 0,
    totalQ,
    isPreTest = false;

// specify the number of questions to select from every pool.
var poolSelections = [
    1, // pool 1
    1, // pool 2
    1, // pool 3
    1, // pool 4
    1, // pool 5
    1, // pool 6
    1, // pool 7
    1, // pool 8
    1, // pool 9
    1, // pool 10
    1, // pool 11
    1 // pool 12
];

function initFormQuiz() {
    window.top.disableNextLesson();
    if ( window.top.getLessonStatus() === "complete" ) {
        window.top.enableNextLesson();
        document.getElementById('instruction').style.display = "none";
        document.getElementById('quiz0').style.display = "none";
        document.getElementById('tempMsg').innerHTML = "You have already completed the Pre Test."
    } else {
        var count = 0,
            i, j, index, len, arr, temp,
            numPools = pools.length,
            pool;
        
        // select one question from every pool
        
        // go through each pool
        for (i = 0; i < numPools; i++) {
            pool = pools[i];
            len = pool.length;
            arr = [];
            // create array of indexes
            for (j = 0; j < len; j++) {
                arr.push(j);
            }
            // randomize array of indexes.
            for (j = len - 1; j > 0; j--) {
                index = Math.floor(Math.random() * (j+1));
                 temp = arr[j];
                arr[j] = arr[index];
                arr[index] = temp;
            }
            // select the appropriate number of item from pool
            for (j = 0; j < poolSelections[i]; j++) {
                count++;
                formQuizData.forms[0].questions[i] = pools[i][arr[j]];
            }
        }
        
        /*
        // For testing all questions:
        var count = 0;
        for (var i = 0; i < pools.length; i++) {
            for(var j = 0; j < pools[i].length; j++){
                formQuizData.forms[0].questions[count] = pools[i][j];
                count++;
            }
        }
        */
        
        totalQ = formQuizData.forms[0].questions.length;
        myFormQuiz = new FormQuiz();
    }   
}



function formQuizReady() {
    document.getElementById('tempMsg').style.display = "none";
}

var lessonResults = [];

var incorrectChoices = [];
var answersForIncorrects = [];

// called for each question every time the form is evaluated
function formQuizQComplete(isCorrect, currForm, currQ) {
    if (isCorrect == 'end') return;
    if (isPreTest) {
        // grab the question data
        var qData = formQuizData.forms[currForm].questions[currQ];
        var i = qData.lessonIndex;
        lessonResults[i] = (lessonResults[i] == null) ? isCorrect : lessonResults[i] && isCorrect;
    }
    if (isCorrect == true) {
        //numCorrect++;
		
		//KS added to disable questions that have been answered correctly
		//console.log(myFormQuiz.choices[currForm][currQ]);
		var curChoices = myFormQuiz.choices[currForm][currQ];
		if(curChoices[0].disabled === false){
			numCorrect++;
		
			for(var i=0; i < curChoices.length; i++) {
				curChoices[i].disabled = true;
			}
		}
		
		//formQuizData.choices[currForm][i][j].disabled = toState;
    }
	else {
		incorrectChoices.push(myFormQuiz.choices[currForm][currQ]);
		answersForIncorrects.push(myFormQuiz.answers[currForm][currQ]);
	}
}

function formQuizComplete(isCorrect, currForm) {
	
    if (isPreTest && (isCorrect == true || isCorrect == "end")) {
        // set passed status
        var lesson, len = lessonResults.length;
        for (lesson = 0; lesson < len; lesson++) {
            if (lessonResults[lesson] === true) {
                window.top.setLessonStatus('passed', lesson);
            }
        }
        // finish pre test
        window.top.enableNextLesson();
        alert("You completed the test with a score of " + Math.round(numCorrect / totalQ * 100) + "%.\n\n Please click Next Lesson to continue.");
			
		// if 100%, complete the Post Test as well, and try to move the current lesson to completion -- DAS 10/27
		// TODO impove so it automatically looks for other isTest lessons, as opposed to having to hard-code the array position of the Post Test.
		if (numCorrect == totalQ) {
			//alert('well done');
            //window.top.setLessonStatus('complete', 8); // Post
            //window.top.setLessonStatus('complete', 9); // Completion
		}
		
		window.top.setLessonStatus('complete');
        window.top.saveLessonProgress('test.html', 0);
        window.top.updateLessonStatus();
        window.top.checkIfGroup();
        window.top.status.isPreTestComplete = true;
    } else {
		//KS added
		var score = Math.round((numCorrect / totalQ) * 100);
		var passing = 80;
		
        if (isCorrect == true || isCorrect == "end") {
            if (score >= passing) {
                /*alert("Congratulations! You passed the test with a score of " + Math.round(numCorrect / totalQ * 100) + "%.\n\n Please click Next Lesson to continue.");
                window.top.setLessonStatus('complete');
                window.top.saveLessonProgress();
                window.top.updateLessonStatus();
                window.top.checkIfGroup();*/
				postTestPassed(score);
            } else {
                alert("You answered " + numCorrect + " out of " + totalQ + " questions correctly for a score of " + score + "%.\n\n Please click the Post Test link in the left menu to try again.");
            }
        }
		else {
			//KS added to give feedback on post test with multiple attempts
			if(score >= passing){
				postTestPassed(score);
				//TODO - Show feedback on questions that were incorrect
				for(var i=0; i<incorrectChoices.length; i++){
					for(var j=0; j<incorrectChoices[i].length; j++){
						incorrectChoices[i][j].disabled = true;
						
						if(incorrectChoices[i][j].checked){
							//is selected
							if(answersForIncorrects[i][j] === 1){
								//should be selected
								incorrectChoices[i][j].parentElement.parentElement.className = "correct";
							}
							else{
								//should not be selected
								incorrectChoices[i][j].parentElement.parentElement.className = "incorrect";
							}
						}
						else {
							//is not selected
							if(answersForIncorrects[i][j] === 1){
								//should be selected
								incorrectChoices[i][j].parentElement.parentElement.className = "shouldCheck";
							}
						}
					}
				}
			}
			else{
				alert("You answered " + numCorrect + " out of " + totalQ + " questions correctly for a score of " + score + "%.\n\n Please try again.");
				
				for(var i=0; i<incorrectChoices.length; i++){
					//clear the incorrect selections
					for(var j=0; j<incorrectChoices[i].length; j++){
						if(incorrectChoices[i][j].checked){
							incorrectChoices[i][j].checked = false;
							incorrectChoices[i][j].parentElement.parentElement.className = "";
						}
					}
				}
				incorrectChoices = [];
				answersForIncorrects = [];
			}
		}
    }
}

function postTestPassed(userScore){
	alert("Congratulations! You passed the test with a score of " + userScore + "%.\n\n Please click Next Lesson to continue.");
	window.top.setLessonStatus('complete');
	window.top.saveLessonProgress('test.html', 0);
	window.top.updateLessonStatus();
	window.top.checkIfGroup();
}